# 18 | 单服务器高性能模式：PPC与TPC

## 笔记

### 高性能架构设计

* 尽量提升单服务器的性能, 将单服务器的心梗发挥到极致.
* 如果单服务器无法支撑性能, 设计服务器集群方案.

**架构设计决定系统性能的上限, 实现细节决定系统性能的下限**.

### 并发模型

* I/O模型
	* 阻塞
	* 非阻塞
	* 同步
	* 异步
* 进程模型
	* 单进程
	* 多进程
	* 多线程

### PPC

PPR(Process Per Connection). 每次有新的连接就新建一个进程去专门处理这个连接的请求.

![](./img/18_01.png)

* 父进程接受连接
* 父进程`fork`子进程
* 子进程处理连接的读写请求
* 子进程关闭连接

```
父进程调用 close, 并没有直接关闭连接, 只是将链接的文件描述符引用计数减一, 真正的关闭连接是等子进程也调用了close后, 连接对应用的文件描述符引用计数变为 0 后, 操作系统次啊会真正关闭连接.
```

#### 缺点

* `fork`代价高.
* 父子进程通信复杂, 需要采用`IPC`
* 支持的并发连接数有限

### prefork

prefork就是**提前创建进程(pre-frok)**. 西戎在启动的时候就预先创建好进程, 然后才开始接受用户的请求. 当有新的连接进来的时候, 就可以省去`fork`进程的操作.

![](./img/18_02.jpg)

Apache 提供了`MPM prefork`模式.

#### 惊群

实现的关键是**多个子进程都`accept`同一个`socket`**, 当有新的连接进入时, 操作系统保证只有一个进程能最后`accept`成功. 

**惊群**就是指虽然只有一个子进程能`accept`成功, 但所有阻塞在`accept`上的子进程都会被唤醒, 这样就导致了不必要的进程调度和上下文切换. Linux2.6 版本后内核已经解决了`accept`惊群问题.

### TPC

TPC(Thread Per Connection). 每次有新的连接就新建一个**线程**去专门处理连接的请求.

![](./img/18_03.png)

* 主进程不用`close`, 因为子线程是共享主进程的进程空间, 只需要一次`close`即可.
* 创建线程比创建进程的代价低.
* 无需进程间通信, 但是会有线程互斥的问题, 容易导致死锁.
* 多线程互相影响, 某个线程出现异常, 可能会导致整个进程退出.

### prethread

`prethread`会预先创建线.

![](./img/18_04.jpg)

* 主进程`accept`, 然后将链接交给某个线程处理.
* 子线程都尝试去`accept`, 最终只有一个线程`accept`成功.

Apache 提供了`MPM worker`模式. 但是做了改进.

* 首先创建多个进程
* 每个进程里面再创阿金多个线程

注释要考虑**稳定性**, 某个子进程里面的某个线程异常导致整个子进程退出, 还会有其他子进程继续提供服务, 不会道正整个服务器全部挂掉.

## 扩展